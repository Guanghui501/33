<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>材料详情 - Nemesis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.1/3Dmol-min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #viewer {
            width: 600px;
            height: 600px;
            margin: auto;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info {
            max-width: 600px;
            margin: 30px auto;
            font-size: 18px;
            word-break: break-word;
            padding: 0 10px;
        }
        .info h2 {
            text-align: center;
            font-size: 26px;
            overflow-wrap: break-word;
        }
        #viewer-message {
            font-size: 16px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="info">
        <h2 id="formula">加载中...</h2>
        <p><strong>能量:</strong> <span id="energy"></span> eV</p>
        <p><strong>质量密度:</strong> <span id="density"></span> g/cm³</p>
        <p><strong>氮浓度:</strong> <span id="n_concentration"></span>%</p>
        <p><strong>爆轰能量 (E<sub>d</sub>):</strong> <span id="ed"></span> kJ/g</p>
        <p><strong>爆轰速度 (V<sub>d</sub>):</strong> <span id="vd"></span> km/s</p>
        <p><strong>爆轰压力 (P<sub>d</sub>):</strong> <span id="pd"></span> GPa</p>
    </div>

    <div id="viewer">
        <div id="viewer-message">加载结构中...</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        fetch('db.json')
            .then(response => response.json())
            .then(data => {
                const material = data[id];
                if (!material) {
                    document.getElementById('formula').innerText = "未找到材料数据。";
                    document.getElementById('viewer-message').innerText = "没有结构数据。";
                    return;
                }

                const formattedFormula = formatFormula(material.formula);
                document.getElementById('formula').innerHTML = formattedFormula;
                document.getElementById('energy').innerText = material.energy?.toFixed(3) ?? 'N/A';
                document.getElementById('density').innerText = material.mass_density?.toFixed(3) ?? 'N/A';
                document.getElementById('n_concentration').innerText = material.N_concentration?.toFixed(3) ?? 'N/A';
                document.getElementById('ed').innerText = material.E_d?.toFixed(3) ?? 'N/A';
                document.getElementById('vd').innerText = material.V_d?.toFixed(3) ?? 'N/A';
                document.getElementById('pd').innerText = material.P_d?.toFixed(3) ?? 'N/A';

                try {
                    const cif = generateCIF(material);
                    const viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
                    viewer.addModel(cif, "cif");
                    viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
                    viewer.zoomTo();
                    viewer.render();

                    const messageDiv = document.getElementById("viewer-message");
                    if (messageDiv) messageDiv.remove();
                } catch (err) {
                    console.error("3D结构渲染失败:", err);
                    document.getElementById('viewer-message').innerText = "加载3D结构失败。";
                }
            })
            .catch(err => {
                console.error("数据获取失败:", err);
                document.getElementById('formula').innerText = "加载材料数据失败。";
                document.getElementById('viewer-message').innerText = "无法获取结构数据。";
            });

        function generateCIF(data) {
            const { cell, symbols, positions } = data;
            let cif = "data_generated\n";
            cif += "_cell_length_a " + cell[0][0].toFixed(6) + "\n";
            cif += "_cell_length_b " + cell[1][1].toFixed(6) + "\n";
            cif += "_cell_length_c " + cell[2][2].toFixed(6) + "\n";
            cif += "_cell_angle_alpha 90\n";
            cif += "_cell_angle_beta 90\n";
            cif += "_cell_angle_gamma 90\n";
            cif += "loop_\n_atom_site_label\n_atom_site_fract_x\n_atom_site_fract_y\n_atom_site_fract_z\n";

            for (let i = 0; i < symbols.length; i++) {
                const [x, y, z] = positions[i];
                const fx = x / cell[0][0];
                const fy = y / cell[1][1];
                const fz = z / cell[2][2];
                cif += `${symbols[i]} ${fx.toFixed(6)} ${fy.toFixed(6)} ${fz.toFixed(6)}\n`;
            }
            return cif;
        }

        function formatFormula(formula) {
            return formula.replace(/(\D)(\d+)/g, (_, element, num) => `${element}<sub>${num}</sub>`);
        }
    </script>
</body>
</html>
